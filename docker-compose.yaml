services:
  certbot-renew:
    image: certbot/certbot:latest
    container_name: certbot-renew
    volumes:
      - ./letsencrypt-config:/etc/letsencrypt
      - ./letsencrypt-lib:/var/lib/letsencrypt
      - ./logs:/var/log/certbot
    command: renew --force-renewal
    restart: 'no'

  ssl-export:
    image: alpine:latest
    container_name: ssl-export
    volumes:
      - ./letsencrypt-config:/certs:ro
      - ./certificates:/export
      - ./logs:/var/log/ssl
    environment:
      - DOMAIN_NAME=${DOMAIN_NAME}
      - DOMAIN_FOLDER=${DOMAIN_FOLDER}
    command: >
      sh -c "
      apk add --no-cache openssl &&
      if [ -f /certs/live/\$DOMAIN_NAME/privkey.pem ]; then
        echo 'Exporting certificates for domain: \$DOMAIN_NAME' &&
        
        # Create directory for domain certificates
        mkdir -p /export/\$DOMAIN_FOLDER &&
        
        echo 'Generating all certificate formats...' &&
        
        # 1. Standard PEM formats (original Let's Encrypt files)
        cp /certs/live/\$DOMAIN_NAME/privkey.pem /export/\$DOMAIN_FOLDER/ &&
        cp /certs/live/\$DOMAIN_NAME/cert.pem /export/\$DOMAIN_FOLDER/ &&
        cp /certs/live/\$DOMAIN_NAME/chain.pem /export/\$DOMAIN_FOLDER/ &&
        cp /certs/live/\$DOMAIN_NAME/fullchain.pem /export/\$DOMAIN_FOLDER/ &&
        
        # 2. Required formats: .key, .crt, intermediate
        cp /certs/live/\$DOMAIN_NAME/privkey.pem /export/\$DOMAIN_FOLDER/\$DOMAIN_NAME.key &&
        cp /certs/live/\$DOMAIN_NAME/cert.pem /export/\$DOMAIN_FOLDER/\$DOMAIN_NAME.crt &&
        cp /certs/live/\$DOMAIN_NAME/chain.pem /export/\$DOMAIN_FOLDER/intermediate.crt &&
        
        # 3. Additional formats for compatibility
        # DER format (binary) - handle both RSA and ECDSA keys
        openssl x509 -in /certs/live/\$DOMAIN_NAME/cert.pem -outform DER -out /export/\$DOMAIN_FOLDER/\$DOMAIN_NAME.der &&
        openssl pkey -in /certs/live/\$DOMAIN_NAME/privkey.pem -outform DER -out /export/\$DOMAIN_FOLDER/\$DOMAIN_NAME.key.der &&
        
        # P7B format (PKCS#7)
        openssl crl2pkcs7 -nocrl -certfile /certs/live/\$DOMAIN_NAME/fullchain.pem -out /export/\$DOMAIN_FOLDER/\$DOMAIN_NAME.p7b &&
        
        # PFX format (PKCS#12) - requires password, using empty password
        openssl pkcs12 -export -out /export/\$DOMAIN_FOLDER/\$DOMAIN_NAME.pfx -inkey /certs/live/\$DOMAIN_NAME/privkey.pem -in /certs/live/\$DOMAIN_NAME/fullchain.pem -passout pass: &&
        
        # Set proper permissions
        chmod 644 /export/\$DOMAIN_FOLDER/*.* &&
        
        # Log success
        echo \"All certificate formats exported successfully for \$DOMAIN_NAME at \$(date)\" >> /var/log/ssl/export.log &&
        echo 'SUCCESS: SSL certificates ready for import' &&
        echo 'Domain: \$DOMAIN_NAME' &&
        echo '' &&
        echo 'Certificate files generated in certificates/\$DOMAIN_FOLDER/:' &&
        echo '' &&
        echo 'ðŸ”‘ REQUIRED FORMATS:' &&
        echo '  - \$DOMAIN_NAME.key (Private Key)' &&
        echo '  - \$DOMAIN_NAME.crt (Certificate)' &&
        echo '  - intermediate.crt (Intermediate Certificate)' &&
        echo '' &&
        echo 'ðŸ“‹ STANDARD FORMATS:' &&
        echo '  - privkey.pem (Private Key - PEM)' &&
        echo '  - cert.pem (Certificate - PEM)' &&
        echo '  - chain.pem (Certificate Chain - PEM)' &&
        echo '  - fullchain.pem (Full Chain - PEM)' &&
        echo '' &&
        echo 'ðŸ”§ ADDITIONAL FORMATS:' &&
        echo '  - \$DOMAIN_NAME.der (Certificate - DER binary)' &&
        echo '  - \$DOMAIN_NAME.key.der (Private Key - DER binary)' &&
        echo '  - \$DOMAIN_NAME.p7b (Certificate Chain - PKCS#7)' &&
        echo '  - \$DOMAIN_NAME.pfx (Certificate + Key - PKCS#12, no password)' &&
        echo '' &&
        ls -la /export/\$DOMAIN_FOLDER/ 2>/dev/null || true
      else
        echo 'ERROR: Certificate files not found at /certs/live/\$DOMAIN_NAME/' &&
        echo 'Available directories:' &&
        ls -la /certs/live/ 2>/dev/null || true &&
        echo 'FAILED: SSL certificate renewal unsuccessful for \$DOMAIN_NAME' >> /var/log/ssl/export.log
      fi
      "
    restart: 'no'
    depends_on:
      - certbot-renew
